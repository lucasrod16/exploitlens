package vuln

import (
	"database/sql"
	"fmt"
)

/*
getCVSSseverity fetches the CVSS severity rating for a given CVE
from the grype vulnerability database and returns it as a string.
*/
func getCVSSseverity(db *sql.DB, cve string) (severity string, err error) {
	query := `
	SELECT severity
	FROM vulnerability_metadata
	WHERE id = ?
	ORDER BY CASE severity
		WHEN 'Negligible' THEN 1
		WHEN 'Low' THEN 2
		WHEN 'Medium' THEN 3
		WHEN 'High' THEN 4
		WHEN 'Critical' THEN 5
		ELSE 6
	END DESC
	LIMIT 1;
	`
	err = db.QueryRow(query, cve).Scan(&severity)
	if err != nil {
		return "", fmt.Errorf("unable to fetch CVSS severity rating from the vulnerability database: %w", err)
	}
	return severity, nil
}
